<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã Game History Log</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 700px; }

        /* Header & Filter */
        .header-bar {
            background: #1e1e24;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            text-align: center;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header-top h2 { margin: 0; color: #ffd700; font-size: 1.4rem; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÅ‡∏•‡∏∞ Dropdown */
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        select {
            padding: 10px 15px;
            border-radius: 8px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            font-size: 1rem;
            cursor: pointer;
            font-family: 'Kanit';
            outline: none;
            min-width: 200px;
        }

        .btn-action {
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            color: white;
            transition: 0.2s;
        }
        .btn-back { background: #444; }
        .btn-pdf { background: #e74c3c; }
        .btn-pdf:hover { background: #c0392b; }

        /* Card ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• */
        .date-card {
            background: #1e1e24;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border-top: 4px solid #00d2d3;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .summary-info {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #aaa;
        }

        /* Table */
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table td { padding: 12px 5px; border-bottom: 1px solid #2a2a35; vertical-align: middle; }
        .history-table tr:last-child td { border-bottom: none; }

        .col-time { width: 50px; color: #00d2d3; font-weight: bold; font-size: 0.9rem; }
        
        .name-text { font-size: 1.1rem; font-weight: 600; color: #fff; display: block; }
        .game-tag { font-size: 0.8rem; background: #2d3436; color: #dfe6e9; padding: 2px 8px; border-radius: 4px; margin-top: 4px; display: inline-block; }

        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; white-space: nowrap; }
        .bg-ok { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .bg-bad { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }

        #no-data { text-align: center; padding: 30px; color: #777; font-style: italic; display: none; }
        #loading { text-align: center; margin-top: 50px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header-bar">
        <div class="header-top">
            <a href="index.html" class="btn-action btn-back"><i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö</a>
            <h2>üìú ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</h2>
            <button onclick="downloadPDF()" class="btn-action btn-pdf"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>

        <div class="controls">
            <label style="color:#aaa;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π: </label>
            <select id="dateSelect" onchange="renderSelectedDate()">
                <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
            </select>
        </div>
    </div>

    <div id="loading"><i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

    <div id="report-content">
        </div>
    
    <div id="no-data">‚ùå ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</div>

</div>

<script>
    // ‚ö†Ô∏è‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ URL ‚ö†Ô∏è‚ö†Ô∏è
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxk7wWNAFnoC9eJ6ZrN22Xi7zoB-hoqPomVgJvkQaGGR5k9oGlBqq-DNQqxBq209FE14g/exec";

    let globalData = []; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    window.onload = function() {
        fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            globalData = data;
            initDateDropdown(data); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        })
        .catch(err => {
            document.getElementById('loading').innerHTML = "‚ùå Error: " + err;
        });
    }

    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    function initDateDropdown(data) {
        const select = document.getElementById('dateSelect');
        select.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤

        // ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ (Unique Dates)
        const uniqueDates = [...new Set(data.map(item => item.date))];
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Reverse ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏≤‡∏£ reverse ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô
        uniqueDates.reverse();

        if (uniqueDates.length === 0) {
            select.innerHTML = "<option>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</option>";
            return;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Option ‡πÉ‡∏ô Dropdown
        uniqueDates.forEach(dateStr => {
            const option = document.createElement('option');
            option.value = dateStr;
            option.text = dateStr;
            select.appendChild(option);
        });

        // ‚úÖ Default: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Option ‡πÅ‡∏£‡∏Å) ‡πÄ‡∏™‡∏°‡∏≠
        select.selectedIndex = 0;
        
        // ‡∏™‡∏±‡πà‡∏á‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        renderSelectedDate();
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function renderSelectedDate() {
        const selectedDate = document.getElementById('dateSelect').value;
        const contentDiv = document.getElementById('report-content');
        const noDataDiv = document.getElementById('no-data');
        
        contentDiv.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡πà‡∏≤

        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        const dayData = globalData.filter(item => item.date === selectedDate);

        if (dayData.length === 0) {
            noDataDiv.style.display = 'block';
            return;
        }
        noDataDiv.style.display = 'none';

        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
        const comeCount = dayData.filter(x => x.status.includes('‡∏°‡∏≤')).length;
        const notComeCount = dayData.length - comeCount;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML
        let html = `
            <div class="date-card">
                <div class="summary-info">
                    <span>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${selectedDate}</span>
                    <span>‡∏°‡∏≤: ${comeCount} | ‡∏ö‡∏¥‡∏î: ${notComeCount}</span>
                </div>
                <table class="history-table">
        `;

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
        dayData.reverse().forEach(row => {
            let statusBadge = row.status.includes('‡∏°‡∏≤') 
                ? `<span class="badge bg-ok"><i class="fas fa-check"></i> ‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô</span>` 
                : `<span class="badge bg-bad"><i class="fas fa-times"></i> ‡∏ö‡∏¥‡∏î</span>`;
            
            let gameName = row.game && row.game !== "-" ? row.game : "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";

            html += `
                <tr>
                    <td class="col-time">${row.time}</td>
                    <td style="text-align:left;">
                        <span class="name-text">${row.name}</span>
                        <span class="game-tag">üéÆ ${gameName}</span>
                    </td>
                    <td style="text-align:right;">${statusBadge}</td>
                </tr>
            `;
        });

        html += `</table></div>`;
        contentDiv.innerHTML = html;
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î PDF (‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
    function downloadPDF() {
        const element = document.getElementById('report-content');
        const selectedDate = document.getElementById('dateSelect').value;
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ PDF
        const opt = {
          margin:       0.5,
          filename:     'GameReport_' + selectedDate.replace(/\//g, '-') + '.pdf', // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, backgroundColor: "#1e1e24" }, // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô
          jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>
